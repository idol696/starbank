# StarBank Recommendation System

## Описание

StarBank – система динамических рекомендаций продуктов для пользователей, основанная на их финансовых транзакциях. API позволяет управлять наборами правил и получать персонализированные рекомендации.

## Архитектура

Проект использует:

- Spring Boot (REST API)
- PostgreSQL (основная БД)
- H2 (тестовая БД)
- Liquibase (миграции БД)
- Spring Data JPA (работа с данными)
- Caffeine Cache (кеширование запросов)

## Основной функционал

### Динамические правила рекомендаций

- `USER_OF` – проверяет, является ли пользователь клиентом указанного типа продуктов.
- `ACTIVE_USER_OF` – проверяет, активно ли пользуется продуктом.
- `TRANSACTION_SUM_COMPARE` – сравнивает суммы транзакций с заданной константой.
- `TRANSACTION_SUM_COMPARE_DEPOSIT_WITHDRAW` – сравнивает суммы пополнений и трат по определённому продукту.

## API

### Управление правилами

#### Добавление нового правила

**POST** `/rule`

```json
{
    "product_name": "Простой кредит",
    "product_id": "ab138afb-f3ba-4a93-b74f-0fcee86d447f",
    "product_text": "Откройте мир выгодных кредитов с нами!",
    "rule": [
        { "query": "USER_OF", "arguments": ["CREDIT"], "negate": true },
        { "query": "TRANSACTION_SUM_COMPARE_DEPOSIT_WITHDRAW", "arguments": ["DEBIT", ">"], "negate": false },
        { "query": "TRANSACTION_SUM_COMPARE", "arguments": ["DEBIT", "EXPENSE", ">", "100000"], "negate": false }
    ]
}
```

#### Получение списка правил

**GET** `/rule` 
Ответ (пример)

Response
200 OK
```json
{
  "data": [
    {
      "id": 1,
      "product_name": "Invest 500",
      "product_id": "147f6a0f-3b91-413b-ab99-87f081d60d5a",
      "product_text": "Откройте свой путь к успеху с индивидуальным инвестиционным счетом...",
      "rules": [
        {
          "query": "USER_OF",
          "arguments": [
            "DEBIT"
          ],
          "negate": false
        },
        {
          "query": "USER_OF",
          "arguments": [
            "INVEST"
          ],
          "negate": true
        },
        {
          "query": "TRANSACTION_SUM_COMPARE",
          "arguments": [
            "SAVING",
            "DEPOSIT",
            ">",
            "1000"
          ],
          "negate": false
        }
      ]
    }
  ]
}
```
#### Удаление правила

**DELETE** `/rule/{ruleId}`

### Получение рекомендаций

**GET** `/recommendation/{userId}` – возвращает список рекомендаций для указанного пользователя.
Response
200 OK
```json
{
  "userId": "UUID пользователя",
  "recommendations": [
    {
      "name": "name рекомендации",
      "id": "UUID рекомендации",
      "text": описание рекомендации"
    }
  ]
}
```

## Telegram Бот

Бот предоставляет рекомендации через Telegram:

### Команды:
- `/start` – стартовое сообщение.
- `/help` – справка по командам.
- `/recommend <username>` – получить рекомендации для пользователя.

## Management API

Для администрирования системы предусмотрены дополнительные эндпоинты:

- **GET** `/management/info` – получение версии программы.
Response
200 OK
{
   "name": "<название сервиса>",
   "version": "<версия сервиса из файла pom.xml>",
}
- **GET** `/management/clear-cache` – очистка кэша.
- **GET** `/rules/stats` – получение статистики по правилам.
Request:
GET /rule/stats

Response
200 OK
```json
{
   "stats":[
      {
         "rule_id":"< id правила>",
         "count":"< число срабатываний этого правила>"
      },
      {
         "rule_id":"< id правила>",
         "count":"< число срабатываний этого правила>"
      }
   ]
}
```

## Возвращаемые значения API
Request:




## База данных

### Таблицы:

- `rule_sets` – наборы правил
- `rules` – правила в наборах

## Кеширование

Используется **Caffeine Cache** для оптимизации повторяющихся запросов к базе данных. Внесены изменения: теперь кеш используется на методах вместо репозитория.

## Ключевые улучшения

- Рефакторинг кода `TelegramListener`.
- Добавлена обработка ошибок: все `RuntimeException` переведены в кастомные ошибки.
- Удалены `@OnDelete` в `Many-To-One`.
- Переработан `switch-case` в стандартный формат.
- Перевод идентификаторов на `UUID`.
- Создан пакет `exceptions`.
- Преобразование старого формата `rules.json` в `new_rules.json`.
- Добавлены тесты для всех сервисов, контроллеров и `RuleService`.
- Добавлена документация по установке и структуре проекта.
- Создан `ManagementController`.
- Создан и внедрен `TelegramRecommendationService`.
- Добавлено описание API в `Swagger`.

## Разработка

- **Spring Boot** – запуск сервиса
- **Liquibase** – миграции БД
- **PostgreSQL** – основная БД
- **H2** – для локального тестирования

## Критерии выполнения

✅ Создание, получение и удаление правил.  
✅ Генерация рекомендаций по динамическим правилам.  
✅ Кеширование запросов для ускорения обработки.  
✅ Интеграция с Telegram-ботом.  
✅ API для администрирования.  
✅ Улучшение обработки ошибок и рефакторинг критичных компонентов.  
